name: Build and Push Docker Image

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      image_tag:
        description: 'Docker image tag'
        required: false
        default: 'latest'
        type: string
  push:
    branches:
      - main
    paths:
      - 'src/**'
  pull_request:
    branches:
      - main
    paths:
      - 'src/**'

env:
  AWS_REGION: ap-south-1

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::199570228070:role/oidc-demo-role
          role-session-name: GitHubActions-Build-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get ECR Repository URI
        id: get-ecr-uri
        run: |
          REPO_NAME="hello-world-lambda-${{ github.event.inputs.environment || 'dev' }}"
          ECR_URI=$(aws ecr describe-repositories --repository-names $REPO_NAME --query 'repositories[0].repositoryUri' --output text)
          echo "ecr_uri=$ECR_URI" >> $GITHUB_OUTPUT
          echo "üì¶ ECR Repository URI: $ECR_URI"

      - name: Verify ECR Repository Exists
        run: |
          REPO_NAME="hello-world-lambda-${{ github.event.inputs.environment || 'dev' }}"
          echo "üîç Verifying ECR repository exists..."
          
          if aws ecr describe-repositories --repository-names $REPO_NAME --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
            echo "‚úÖ ECR repository '$REPO_NAME' exists"
          else
            echo "‚ùå ECR repository '$REPO_NAME' does not exist!"
            echo "Please run the ECR workflow first to create the repository"
            exit 1
          fi

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.get-ecr-uri.outputs.ecr_uri }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=${{ github.event.inputs.image_tag || 'latest' }}
            type=raw,value={{date 'YYYYMMDD-HHmmss'}}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate Python Code Before Building
        run: |
          echo "üîç Validating Python code syntax and imports..."
          
          cd src
          
          if [ ! -f "app.py" ]; then
            echo "‚ùå app.py not found in src directory"
            ls -la
            exit 1
          fi
          
          echo "‚úÖ app.py found"
          
          python3 -m py_compile app.py
          echo "‚úÖ Python syntax is valid"
          
          python3 -c "
          import json
          import logging
          print('‚úÖ Standard library imports successful')
          "
          
          python3 -c "
          import sys
          import os
          
          current_dir = os.getcwd()
          if current_dir not in sys.path:
              sys.path.insert(0, current_dir)
          
          try:
              import app
              print('‚úÖ App module imported successfully')
          except ImportError as e:
              print(f'‚ùå Failed to import app module: {e}')
              sys.exit(1)
          
          if not hasattr(app, 'lambda_handler'):
              print('‚ùå lambda_handler function not found in app module')
              sys.exit(1)
          
          if not callable(app.lambda_handler):
              print('‚ùå lambda_handler is not callable')
              sys.exit(1)
          
          import inspect
          sig = inspect.signature(app.lambda_handler)
          params = list(sig.parameters.keys())
          
          if len(params) != 2:
              print(f'‚ùå lambda_handler should have 2 parameters, found {len(params)}: {params}')
              sys.exit(1)
          
          print(f'‚úÖ lambda_handler function has correct signature: {params}')
          "
          
          echo "‚úÖ All Python validation checks passed"

      - name: Build Docker image locally first
        run: |
          echo "üî® Building Docker image locally for validation..."
          cd src
          
          # Build with explicit platform for Lambda compatibility
          docker build \
            --platform linux/amd64 \
            --tag test-lambda-image \
            --file Dockerfile \
            .
          
          echo "‚úÖ Local build successful"

      - name: Validate Docker Image Structure
        run: |
          echo "üß™ Validating Docker image structure..."
          
          if docker images test-lambda-image | grep -q test-lambda-image; then
            echo "‚úÖ Docker image exists"
          else
            echo "‚ùå Docker image not found"
            exit 1
          fi
          
          ARCH=$(docker inspect test-lambda-image --format='{{.Architecture}}')
          echo "üèóÔ∏è Image architecture: $ARCH"
          
          if [ "$ARCH" != "amd64" ]; then
            echo "‚ùå Image architecture should be amd64 for Lambda compatibility"
            exit 1
          fi
          
          IMAGE_SIZE=$(docker images test-lambda-image --format "table {{.Size}}" | tail -n 1)
          echo "üìä Image size: $IMAGE_SIZE"
          
          echo "üìÅ Checking image contents..."
          docker run --rm --platform linux/amd64 --entrypoint="" test-lambda-image ls -la /var/task/
          
          if docker run --rm --platform linux/amd64 --entrypoint="" test-lambda-image test -f /var/task/app.py; then
            echo "‚úÖ app.py found in image"
          else
            echo "‚ùå app.py not found in image"
            exit 1
          fi
          
          echo "‚úÖ Docker image structure validation passed"

      - name: Test Python Environment in Container
        run: |
          echo "üêç Testing Python environment in container..."
          
          echo "üìã Python version:"
          docker run --rm --platform linux/amd64 --entrypoint="" test-lambda-image python --version
          
          echo "üì¶ Testing module import in container..."
          docker run --rm --platform linux/amd64 --entrypoint="" test-lambda-image python -c "
          import sys
          import os
          
          task_root = '/var/task'
          if task_root not in sys.path:
              sys.path.insert(0, task_root)
          
          try:
              import app
              print('‚úÖ App module imports successfully in container')
          except Exception as e:
              print(f'‚ùå App module import failed: {e}')
              sys.exit(1)
          
          if not hasattr(app, 'lambda_handler'):
              print('‚ùå lambda_handler function not found in container')
              sys.exit(1)
          
          if not callable(app.lambda_handler):
              print('‚ùå lambda_handler is not callable in container')
              sys.exit(1)
          
          print('‚úÖ lambda_handler function is accessible in container')
          "
          
          echo "‚úÖ All Python environment tests passed"

      - name: Test Lambda Runtime Interface
        run: |
          echo "üîß Testing Lambda Runtime Interface..."
          
          CMD=$(docker inspect test-lambda-image --format='{{.Config.Cmd}}')
          echo "üìã Container CMD: $CMD"
          
          if [[ "$CMD" != *"app.lambda_handler"* ]]; then
            echo "‚ùå Container CMD should reference app.lambda_handler"
            exit 1
          fi
          
          echo "üß™ Testing Lambda handler invocation..."
          docker run --rm --platform linux/amd64 --entrypoint="" test-lambda-image python -c "
          import app
          import json
          
          event = {
              'httpMethod': 'GET',
              'path': '/',
              'headers': {'Accept': 'application/json'},
              'queryStringParameters': None
          }
          
          class MockContext:
              def __init__(self):
                  self.function_name = 'test-function'
                  self.function_version = '\$LATEST'
                  self.memory_limit_in_mb = '256'
                  self.aws_request_id = 'test-request-id'
              
              def get_remaining_time_in_millis(self):
                  return 30000
          
          context = MockContext()
          
          try:
              response = app.lambda_handler(event, context)
              print('‚úÖ Lambda handler executed successfully')
              print(f'üìä Response status: {response.get(\"statusCode\", \"N/A\")}')
              
              required_keys = ['statusCode', 'headers', 'body']
              for key in required_keys:
                  if key not in response:
                      print(f'‚ùå Missing required key: {key}')
                      sys.exit(1)
              
              print('‚úÖ Response structure is valid')
              
          except Exception as e:
              print(f'‚ùå Lambda handler test failed: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "
          
          echo "‚úÖ Lambda runtime interface test passed"

      - name: Build and push Docker image to ECR
        uses: docker/build-push-action@v5
        with:
          context: ./src
          file: ./src/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          provenance: false
          sbom: false
          outputs: type=image,name=${{ steps.get-ecr-uri.outputs.ecr_uri }},push=true

      - name: Verify image was pushed successfully
        if: github.event_name != 'pull_request'
        run: |
          echo "üîç Verifying image was pushed to ECR..."
          IMAGE_URI="${{ steps.get-ecr-uri.outputs.ecr_uri }}:${{ github.event.inputs.image_tag || 'latest' }}"
          
          sleep 15
          
          if aws ecr describe-images --repository-name "hello-world-lambda-${{ github.event.inputs.environment || 'dev' }}" --image-ids imageTag="${{ github.event.inputs.image_tag || 'latest' }}" --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
            echo "‚úÖ Image successfully pushed to ECR: $IMAGE_URI"
            
            IMAGE_DETAILS=$(aws ecr describe-images --repository-name "hello-world-lambda-${{ github.event.inputs.environment || 'dev' }}" --image-ids imageTag="${{ github.event.inputs.image_tag || 'latest' }}" --region ${{ env.AWS_REGION }})
            IMAGE_SIZE=$(echo $IMAGE_DETAILS | jq -r '.imageDetails[0].imageSizeInBytes')
            PUSH_DATE=$(echo $IMAGE_DETAILS | jq -r '.imageDetails[0].imagePushedAt')
            IMAGE_DIGEST=$(echo $IMAGE_DETAILS | jq -r '.imageDetails[0].imageDigest')
            
            echo "üìä Image size: $(($IMAGE_SIZE / 1024 / 1024)) MB"
            echo "üìÖ Push date: $PUSH_DATE"
            echo "üîç Image digest: $IMAGE_DIGEST"
            
            echo "üîç Verifying image manifest..."
            MANIFEST=$(aws ecr batch-get-image --repository-name "hello-world-lambda-${{ github.event.inputs.environment || 'dev' }}" --image-ids imageTag="${{ github.event.inputs.image_tag || 'latest' }}" --query 'images[0].imageManifest' --output text --region ${{ env.AWS_REGION }})
            
            if [ "$MANIFEST" != "None" ] && [ "$MANIFEST" != "" ]; then
              echo "‚úÖ Image manifest is valid"
            else
              echo "‚ùå Image manifest is invalid or missing"
              exit 1
            fi
            
          else
            echo "‚ùå Image not found in ECR after push!"
            echo "Listing all images in repository:"
            aws ecr list-images --repository-name "hello-world-lambda-${{ github.event.inputs.environment || 'dev' }}" --region ${{ env.AWS_REGION }}
            exit 1
          fi

      - name: Image vulnerability scan
        if: github.event_name != 'pull_request'
        run: |
          echo "üîí Running security scan on Docker image..."
          
          sudo apt-get update
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy
          
          IMAGE_URI="${{ steps.get-ecr-uri.outputs.ecr_uri }}:${{ github.event.inputs.image_tag || 'latest' }}"
          echo "üîç Scanning image: $IMAGE_URI"
          trivy image --exit-code 0 --severity HIGH,CRITICAL $IMAGE_URI

    outputs:
      image_uri: ${{ steps.get-ecr-uri.outputs.ecr_uri }}:${{ github.event.inputs.image_tag || 'latest' }}